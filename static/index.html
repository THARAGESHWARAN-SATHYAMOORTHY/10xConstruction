<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coverage Path Planning | Engineering Dashboard</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-body: #f1f5f9;
            --bg-panel: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- Sidebar Styling --- */
        .sidebar {
            width: 340px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100%;
            z-index: 10;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h1 {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-main);
        }

        .sidebar-header p {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 24px;
        }

        /* --- Form Elements --- */
        .input-row { margin-bottom: 12px; }
        .input-row:last-child { margin-bottom: 0; }

        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-main);
        }

        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            transition: all 0.2s;
            background: white;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* --- Buttons --- */
        .btn {
            width: 100%;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; transform: none; }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-secondary:hover { background: #f8fafc; border-color: #cbd5e1; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; width: auto; }
        .btn-danger { background: #fee2e2; color: #b91c1c; }
        .btn-danger:hover { background: #fecaca; }

        /* --- Obstacle List --- */
        .obstacle-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }

        .obstacle-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .obstacle-info { display: flex; flex-direction: column; }
        .obstacle-coords { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted); }

        /* --- Main Visualization Area --- */
        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-body);
            position: relative;
        }

        .toolbar {
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .tab-group { display: flex; gap: 24px; height: 100%; }
        
        .tab-btn {
            background: none;
            border: none;
            height: 100%;
            padding: 0 4px;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .tab-btn:hover { color: var(--primary); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        .content-area {
            flex: 1;
            padding: 24px;
            overflow: auto;
            position: relative; /* Context for HUD */
        }

        /* --- Visualization Layout (Canvas + Side Legend) --- */
        .vis-container {
            display: flex;
            gap: 24px;
            align-items: flex-start;
            justify-content: center;
            height: 100%;
        }

        .canvas-card {
            background: white;
            padding: 16px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            position: relative;
            flex: 1;
            max-width: 900px; /* Limit canvas width slightly for aesthetics */
            display: flex;
            justify-content: center;
        }

        canvas {
            background: #fafafa;
            border-radius: 4px;
            cursor: crosshair;
            display: block;
            max-width: 100%;
            height: auto;
        }

        /* --- Vertical Legend Card --- */
        .legend-card {
            width: 200px;
            background: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
        }

        .legend-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 700;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            font-size: 0.85rem;
            color: var(--text-main);
            font-weight: 500;
        }

        .dot { width: 12px; height: 12px; border-radius: 3px; }

        /* --- HUD --- */
        .hud-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 16px;
            border: 1px solid var(--border);
            z-index: 100;
        }

        .icon-btn {
            background: none;
            border: none;
            font-size: 1.1rem;
            color: var(--text-main);
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .icon-btn:hover { background: #f1f5f9; color: var(--primary); }

        /* --- Statistics Tab --- */
        .stats-wrapper { width: 100%; max-width: 1000px; margin: 0 auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }
        .stat-card h4 { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; font-weight: 600; margin-bottom: 8px; }
        .stat-card .value { font-size: 1.5rem; font-weight: 700; color: var(--text-main); font-family: 'JetBrains Mono', monospace; letter-spacing: -0.5px; }
        .stat-card .unit { font-size: 0.8rem; color: var(--text-muted); margin-left: 2px; font-weight: 500; }

        /* Detailed Stats */
        .details-panel { background: white; border-radius: var(--radius-lg); border: 1px solid var(--border); overflow: hidden; box-shadow: var(--shadow-sm); }
        .details-header { background: #f8fafc; padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; font-weight: 600; color: var(--text-main); font-size: 0.95rem; }
        .detail-row { display: flex; justify-content: space-between; align-items: center; padding: 14px 24px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { color: var(--text-muted); font-weight: 500; }
        .detail-value { font-family: 'JetBrains Mono', monospace; color: var(--text-main); font-weight: 600; }

        /* --- Alerts --- */
        .alert-container { position: fixed; top: 24px; right: 24px; z-index: 1000; }
        .alert { background: white; padding: 16px 20px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-left: 4px solid #ccc; display: flex; align-items: center; gap: 12px; min-width: 300px; animation: slideIn 0.3s ease; }
        .alert-success { border-left-color: var(--success); }
        .alert-success i { color: var(--success); }
        .alert-error { border-left-color: var(--danger); }
        .alert-error i { color: var(--danger); }

        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .loading-spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        input[type=range] { width: 100px; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">
            <h1><i class="fa-solid fa-robot" style="color: var(--primary);"></i> PathPlanner</h1>
            <p>Boustrophedon Cellular Decomposition</p>
        </div>

        <div class="sidebar-content">
            <div class="section-title"><i class="fa-solid fa-ruler-combined"></i> Environment Setup</div>
            <div class="control-group">
                <div class="input-row">
                    <label>Wall Width (m)</label>
                    <input type="number" id="wallWidth" value="5.0" min="1" max="50" step="0.1">
                </div>
                <div class="input-row">
                    <label>Wall Height (m)</label>
                    <input type="number" id="wallHeight" value="5.0" min="1" max="50" step="0.1">
                </div>
                <div class="input-row">
                    <label>Tool Width (m)</label>
                    <input type="number" id="toolWidth" value="0.25" min="0.1" max="5" step="0.05">
                </div>
            </div>

            <div class="section-title"><i class="fa-solid fa-shapes"></i> Obstacles</div>
            <div class="control-group">
                <div class="input-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>X (m)</label>
                        <input type="number" id="obsX" value="2.0" min="0" step="0.1">
                    </div>
                    <div>
                        <label>Y (m)</label>
                        <input type="number" id="obsY" value="2.0" min="0" step="0.1">
                    </div>
                </div>
                <div class="input-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>W (m)</label>
                        <input type="number" id="obsWidth" value="0.5" min="0.1" step="0.1">
                    </div>
                    <div>
                        <label>H (m)</label>
                        <input type="number" id="obsHeight" value="0.5" min="0.1" step="0.1">
                    </div>
                </div>
                <button class="btn btn-secondary" style="margin-top: 10px;" onclick="addObstacle()">
                    <i class="fa-solid fa-plus"></i> Add Obstacle
                </button>

                <div id="obstacleList" class="obstacle-list"></div>
            </div>

            <button onclick="planPath()" id="planBtn" class="btn btn-primary" style="margin-top: auto;">
                <i class="fa-solid fa-bolt"></i> Generate Coverage Path
            </button>
        </div>
    </aside>

    <main class="main-wrapper">
        <div class="toolbar">
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchTab('visualization')"><i class="fa-regular fa-map"></i> Visualization</button>
                <button class="tab-btn" onclick="switchTab('statistics')"><i class="fa-solid fa-chart-line"></i> Analytics</button>
            </div>
        </div>

        <div id="visualizationTab" class="content-area">
            
            <div class="vis-container">
                <div class="canvas-card">
                    <canvas id="canvas" width="800" height="800"></canvas>
                </div>

                <div class="legend-card">
                    <div class="legend-title">Map Legend</div>
                    <div class="legend-item"><div class="dot" style="background: #e9ecef; border: 1px solid #999;"></div> Wall</div>
                    <div class="legend-item"><div class="dot" style="background: #334155;"></div> Obstacles</div>
                    <div class="legend-item"><div class="dot" style="background: var(--success);"></div> Coverage</div>
                    <div class="legend-item"><div class="dot" style="background: var(--warning);"></div> Transition</div>
                    <div class="legend-item"><div class="dot" style="background: var(--danger);"></div> Tool</div>
                </div>
            </div>

            <div class="hud-controls" id="playbackControls" style="display: none;">
                <button class="icon-btn" onclick="resetPlayback()" title="Restart"><i class="fa-solid fa-rotate-left"></i></button>
                <button class="icon-btn" onclick="startPlayback()" title="Play"><i class="fa-solid fa-play"></i></button>
                <button class="icon-btn" onclick="pausePlayback()" title="Pause"><i class="fa-solid fa-pause"></i></button>
                <button class="icon-btn" onclick="stepForward()" title="Step"><i class="fa-solid fa-shoe-prints"></i></button>
                
                <div style="width: 1px; height: 24px; background: var(--border);"></div>
                
                <div style="display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: var(--text-muted);">
                    <i class="fa-solid fa-gauge-high"></i>
                    <input type="range" id="speedSlider" min="1" max="100" value="50">
                    <span id="speedValue" style="width: 25px; text-align: right;">50</span>
                </div>
            </div>
        </div>

        <div id="statisticsTab" class="content-area" style="display: none;">
            <div id="statisticsContent" class="stats-wrapper">
                <div style="text-align: center; color: var(--text-muted); margin-top: 100px;">
                    <i class="fa-solid fa-chart-pie" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"></i>
                    <p>No path generated yet.<br>Configure obstacles and click 'Generate Coverage Path'.</p>
                </div>
            </div>
        </div>
    </main>

    <div class="alert-container" id="alertContainer"></div>

    <script>
        // Global state
        let obstacles = [];
        let pathSegments = [];
        let currentSegment = 0;
        let isPlaying = false;
        let animationId = null;
        let wallWidth = 5.0;
        let wallHeight = 5.0;
        let metadata = {};

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Initialize
        resizeCanvas();
        drawWall();
        updateObstacleList();

        window.addEventListener('resize', () => {
             drawWall();
             if(pathSegments.length > 0) drawPath(currentSegment);
        });

        function resizeCanvas() {
            // Internal resolution logic if needed
        }

        function addObstacle() {
            const x = parseFloat(document.getElementById('obsX').value);
            const y = parseFloat(document.getElementById('obsY').value);
            const width = parseFloat(document.getElementById('obsWidth').value);
            const height = parseFloat(document.getElementById('obsHeight').value);

            if (x + width > wallWidth || y + height > wallHeight) {
                showAlert('error', 'Obstacle extends beyond wall boundaries!');
                return;
            }

            obstacles.push({ x, y, width, height });
            updateObstacleList();
            drawWall();
        }

        function removeObstacle(index) {
            obstacles.splice(index, 1);
            updateObstacleList();
            drawWall();
        }

        function updateObstacleList() {
            const list = document.getElementById('obstacleList');
            if (obstacles.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-muted); font-size: 0.8rem; padding: 10px; border: 1px dashed var(--border); border-radius: 6px;">No obstacles configured</div>';
                return;
            }

            list.innerHTML = obstacles.map((obs, i) => `
                <div class="obstacle-item">
                    <div class="obstacle-info">
                        <strong>Object #${i + 1}</strong>
                        <span class="obstacle-coords">(${obs.x}, ${obs.y}) • ${obs.width}×${obs.height}m</span>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeObstacle(${i})" title="Remove">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        async function planPath() {
            const btn = document.getElementById('planBtn');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner"></div> Processing...';

            wallWidth = parseFloat(document.getElementById('wallWidth').value);
            wallHeight = parseFloat(document.getElementById('wallHeight').value);
            const toolWidth = parseFloat(document.getElementById('toolWidth').value);

            try {
                // Mock API logic for preview. 
                // UNCOMMENT the fetch block below for real backend connection.
                /* const data = {
                    path_segments: [], 
                    total_length: 105.00,
                    coverage_length: 105.00,
                    transition_length: 0.00,
                    coverage_percentage: 95.2,
                    execution_time_ms: 12,
                    num_cells: 1,
                    num_segments: 21
                };
                */
                
                // Real API Connection
                const response = await fetch('/api/plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        wall_width: wallWidth,
                        wall_height: wallHeight,
                        tool_width: toolWidth,
                        obstacles: obstacles
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to plan path');
                }

                pathSegments = data.path_segments;
                metadata = {
                    total_length: data.total_length,
                    coverage_length: data.coverage_length,
                    transition_length: data.transition_length,
                    coverage_percentage: data.coverage_percentage,
                    execution_time_ms: data.execution_time_ms,
                    num_cells: data.num_cells,
                    num_segments: data.num_segments
                };

                currentSegment = 0;
                drawPath();
                showStats();
                document.getElementById('playbackControls').style.display = 'flex';
                
                switchTab('visualization');
                showAlert('success', 'Path generated successfully!');

            } catch (error) {
                showAlert('error', error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }

        // --- Visualization Logic ---
        function drawWall() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const padding = 60;
            const availWidth = canvas.width - 2 * padding;
            const availHeight = canvas.height - 2 * padding;
            const scale = Math.min(availWidth / wallWidth, availHeight / wallHeight);

            // Draw Wall Area
            ctx.fillStyle = '#f8fafc';
            ctx.fillRect(padding, padding, wallWidth * scale, wallHeight * scale);
            ctx.strokeStyle = '#cbd5e1';
            ctx.lineWidth = 2;
            ctx.strokeRect(padding, padding, wallWidth * scale, wallHeight * scale);

            // Draw Grid
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (let i = 0; i <= wallWidth; i++) {
                ctx.moveTo(padding + i * scale, padding);
                ctx.lineTo(padding + i * scale, padding + wallHeight * scale);
            }
            for (let i = 0; i <= wallHeight; i++) {
                ctx.moveTo(padding, padding + i * scale);
                ctx.lineTo(padding + wallWidth * scale, padding + i * scale);
            }
            ctx.stroke();

            // Draw Obstacles
            ctx.fillStyle = '#334155';
            obstacles.forEach(obs => {
                ctx.fillRect(
                    padding + obs.x * scale,
                    padding + obs.y * scale,
                    obs.width * scale,
                    obs.height * scale
                );
                ctx.strokeStyle = '#1e293b';
                ctx.strokeRect(
                    padding + obs.x * scale,
                    padding + obs.y * scale,
                    obs.width * scale,
                    obs.height * scale
                );
            });
        }

        function drawPath(upToSegment = pathSegments.length) {
            drawWall();

            const padding = 60;
            const scale = Math.min(
                (canvas.width - 2 * padding) / wallWidth,
                (canvas.height - 2 * padding) / wallHeight
            );

            for (let i = 0; i < upToSegment && i < pathSegments.length; i++) {
                const seg = pathSegments[i];
                
                ctx.beginPath();
                ctx.moveTo(padding + seg.start_x * scale, padding + seg.start_y * scale);
                ctx.lineTo(padding + seg.end_x * scale, padding + seg.end_y * scale);
                
                if (seg.segment_type === 'coverage') {
                    ctx.strokeStyle = '#10b981';
                    ctx.lineWidth = 3;
                    ctx.setLineDash([]);
                } else {
                    ctx.strokeStyle = '#f59e0b';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                }
                
                ctx.stroke();
            }

            if (upToSegment > 0 && upToSegment <= pathSegments.length) {
                const seg = pathSegments[upToSegment - 1];
                const x = padding + seg.end_x * scale;
                const y = padding + seg.end_y * scale;

                ctx.shadowColor = "rgba(239, 68, 68, 0.4)";
                ctx.shadowBlur = 10;
                
                ctx.fillStyle = '#ef4444';
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, 2 * Math.PI);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        }

        // --- Controls ---
        function startPlayback() {
            if (isPlaying) return;
            isPlaying = true;
            animate();
        }

        function pausePlayback() {
            isPlaying = false;
            if (animationId) cancelAnimationFrame(animationId);
        }

        function resetPlayback() {
            pausePlayback();
            currentSegment = 0;
            drawPath(0);
        }

        function stepForward() {
            if (currentSegment < pathSegments.length) {
                currentSegment++;
                drawPath(currentSegment);
            }
        }

        function animate() {
            if (!isPlaying) return;
            if (currentSegment < pathSegments.length) {
                currentSegment++;
                drawPath(currentSegment);
                const speed = parseInt(document.getElementById('speedSlider').value);
                setTimeout(() => {
                    animationId = requestAnimationFrame(animate);
                }, 1000 / speed);
            } else {
                isPlaying = false;
            }
        }

        document.getElementById('speedSlider').addEventListener('input', (e) => {
            document.getElementById('speedValue').textContent = e.target.value;
        });

        // --- Tabs & Stats ---
        function switchTab(tabName) {
            document.querySelectorAll('.content-area').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            if (tabName === 'visualization') {
                document.getElementById('visualizationTab').style.display = 'block';
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
            } else {
                document.getElementById('statisticsTab').style.display = 'block';
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
            }
        }

        function showStats() {
            const container = document.getElementById('statisticsContent');
            const toolW = parseFloat(document.getElementById('toolWidth').value);
            const avgSeg = metadata.num_segments > 0 ? (metadata.total_length / metadata.num_segments).toFixed(2) : "0.00";
            
            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Total Path Length</h4>
                        <div class="value">${metadata.total_length.toFixed(2)}<span class="unit">m</span></div>
                    </div>
                    <div class="stat-card">
                        <h4>Coverage Length</h4>
                        <div class="value" style="color: var(--success);">${metadata.coverage_length.toFixed(2)}<span class="unit">m</span></div>
                    </div>
                    <div class="stat-card">
                        <h4>Transition Length</h4>
                        <div class="value" style="color: var(--warning);">${metadata.transition_length.toFixed(2)}<span class="unit">m</span></div>
                    </div>
                    <div class="stat-card">
                        <h4>Coverage Efficiency</h4>
                        <div class="value" style="color: var(--primary);">${metadata.coverage_percentage.toFixed(1)}<span class="unit">%</span></div>
                    </div>
                    <div class="stat-card">
                        <h4>Number of Cells</h4>
                        <div class="value">${metadata.num_cells}<span class="unit">cells</span></div>
                    </div>
                    <div class="stat-card">
                        <h4>Path Segments</h4>
                        <div class="value">${metadata.num_segments}<span class="unit">segments</span></div>
                    </div>
                    <div class="stat-card">
                        <h4>Planning Time</h4>
                        <div class="value">${metadata.execution_time_ms}<span class="unit">ms</span></div>
                    </div>
                    <div class="stat-card">
                        <h4>Tool Width</h4>
                        <div class="value">${toolW.toFixed(2)}<span class="unit">m</span></div>
                    </div>
                </div>

                <div class="details-panel">
                    <div class="details-header">
                        <i class="fa-solid fa-file-waveform"></i>
                        Detailed Information
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Wall Dimensions:</span>
                        <span class="detail-value">${wallWidth.toFixed(1)}m × ${wallHeight.toFixed(1)}m</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Number of Obstacles:</span>
                        <span class="detail-value">${obstacles.length}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Coverage Ratio:</span>
                        <span class="detail-value">${metadata.coverage_percentage.toFixed(1)}%</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Average Segment Length:</span>
                        <span class="detail-value">${avgSeg}m</span>
                    </div>
                </div>
            `;
        }

        // --- Alerts ---
        function showAlert(type, message) {
            const container = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            const icon = type === 'success' ? 'fa-circle-check' : 'fa-triangle-exclamation';
            const className = type === 'success' ? 'alert-success' : 'alert-error';

            alertDiv.className = `alert ${className}`;
            alertDiv.innerHTML = `<i class="fa-solid ${icon}"></i><span>${message}</span>`;
            
            container.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.style.opacity = '0';
                alertDiv.style.transform = 'translateX(100%)';
                setTimeout(() => alertDiv.remove(), 300);
            }, 4000);
        }
    </script>
</body>
</html>